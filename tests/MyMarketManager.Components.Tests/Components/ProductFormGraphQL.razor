@page "/products-graphql/add"
@page "/products-graphql/edit/{productId:guid}"
@using MyMarketManager.GraphQL.Client
@inject IMyMarketManagerClient GraphQLClient
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>@(ProductId.HasValue ? "Edit Product" : "Add Product")</PageTitle>

<div class="row">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/products-graphql">Products</a></li>
                <li class="breadcrumb-item active">@(ProductId.HasValue ? "Edit" : "Add")</li>
            </ol>
        </nav>

        <h1>@(ProductId.HasValue ? "Edit Product" : "Add Product")</h1>

        @if (errorMessage != null)
        {
            <div class="alert alert-danger">
                <i class="bi bi-exclamation-triangle"></i> @errorMessage
            </div>
        }

        <EditForm Model="@productModel" OnValidSubmit="@SaveProduct" FormName="ProductFormGraphQL">
            <DataAnnotationsValidator />
            <ValidationSummary class="alert alert-danger" />

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="sku" class="form-label">SKU</label>
                        <InputText id="sku" class="form-control" @bind-Value="productModel.SKU" placeholder="Optional product SKU" />
                        <ValidationMessage For="@(() => productModel.SKU)" />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="quality" class="form-label">Quality Rating</label>
                        <InputSelect id="quality" class="form-select" @bind-Value="productModel.Quality">
                            @foreach (var quality in Enum.GetValues<ProductQuality>())
                            {
                                <option value="@quality">@quality</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => productModel.Quality)" />
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
                <InputText id="name" class="form-control" @bind-Value="productModel.Name" placeholder="Enter product name" />
                <ValidationMessage For="@(() => productModel.Name)" />
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <InputTextArea id="description" class="form-control" rows="3" @bind-Value="productModel.Description" placeholder="Product description (optional)" />
                <ValidationMessage For="@(() => productModel.Description)" />
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="stock" class="form-label">Stock on Hand</label>
                        <InputNumber id="stock" class="form-control" @bind-Value="productModel.StockOnHand" min="0" />
                        <ValidationMessage For="@(() => productModel.StockOnHand)" />
                        <div class="form-text">Current inventory level</div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="notes" class="form-label">Notes</label>
                <InputTextArea id="notes" class="form-control" rows="2" @bind-Value="productModel.Notes" placeholder="Additional notes (optional)" />
                <ValidationMessage For="@(() => productModel.Notes)" />
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" disabled="@saving">
                    @if (saving)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <i class="bi bi-check-circle"></i>
                        <span>@(ProductId.HasValue ? "Update Product" : "Create Product")</span>
                    }
                </button>
                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                    Cancel
                </button>
            </div>
        </EditForm>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quality Guide</h5>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <span class="badge bg-success">Excellent</span>
                        <div class="text-muted">Superior condition, no defects</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-primary">Good</span>
                        <div class="text-muted">Minor imperfections, fully functional</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-warning">Fair</span>
                        <div class="text-muted">Noticeable flaws but acceptable</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-danger">Poor</span>
                        <div class="text-muted">Significant defects, limited usability</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-dark">Terrible</span>
                        <div class="text-muted">Severe damage, may not be sellable</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid? ProductId { get; set; }

    private ProductFormModel productModel = new();
    private bool saving = false;
    private bool loading = true;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        if (ProductId.HasValue)
        {
            await LoadProduct();
        }
        else
        {
            // Initialize default values for new product
            productModel = new ProductFormModel
            {
                Quality = ProductQuality.Good,
                StockOnHand = 0
            };
            loading = false;
        }
    }

    private async Task LoadProduct()
    {
        loading = true;
        errorMessage = null;
        
        try
        {
            var result = await GraphQLClient.GetProductById.ExecuteAsync(ProductId!.Value);
            
            if (result.Errors != null && result.Errors.Count > 0)
            {
                errorMessage = "Error loading product: " + string.Join(", ", result.Errors.Select(e => e.Message));
                // Product not found, redirect to products list
                Navigation.NavigateTo("/products-graphql");
            }
            else if (result.Data?.ProductById != null)
            {
                var product = result.Data.ProductById;
                productModel = new ProductFormModel
                {
                    SKU = product.Sku,
                    Name = product.Name,
                    Description = product.Description,
                    Quality = product.Quality,
                    Notes = product.Notes,
                    StockOnHand = product.StockOnHand
                };
            }
            else
            {
                // Product not found, redirect to products list
                Navigation.NavigateTo("/products-graphql");
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading product: {ex.Message}";
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading product:", ex.Message);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task SaveProduct()
    {
        saving = true;
        errorMessage = null;
        
        try
        {
            if (ProductId.HasValue)
            {
                // Update existing product
                var input = new UpdateProductInput
                {
                    Sku = productModel.SKU,
                    Name = productModel.Name ?? string.Empty,
                    Description = productModel.Description,
                    Quality = productModel.Quality,
                    Notes = productModel.Notes,
                    StockOnHand = productModel.StockOnHand
                };
                
                var result = await GraphQLClient.UpdateProduct.ExecuteAsync(ProductId.Value, input);
                
                if (result.Errors != null && result.Errors.Count > 0)
                {
                    errorMessage = "Error updating product: " + string.Join(", ", result.Errors.Select(e => e.Message));
                    await JSRuntime.InvokeVoidAsync("alert", errorMessage);
                }
                else
                {
                    Navigation.NavigateTo("/products-graphql");
                }
            }
            else
            {
                // Add new product
                var input = new CreateProductInput
                {
                    Sku = productModel.SKU,
                    Name = productModel.Name ?? string.Empty,
                    Description = productModel.Description,
                    Quality = productModel.Quality,
                    Notes = productModel.Notes,
                    StockOnHand = productModel.StockOnHand
                };
                
                var result = await GraphQLClient.CreateProduct.ExecuteAsync(input);
                
                if (result.Errors != null && result.Errors.Count > 0)
                {
                    errorMessage = "Error creating product: " + string.Join(", ", result.Errors.Select(e => e.Message));
                    await JSRuntime.InvokeVoidAsync("alert", errorMessage);
                }
                else
                {
                    Navigation.NavigateTo("/products-graphql");
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving product: {ex.Message}";
            await JSRuntime.InvokeVoidAsync("alert", errorMessage);
        }
        finally
        {
            saving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/products-graphql");
    }

    // Model class for the form
    public class ProductFormModel
    {
        public string? SKU { get; set; }
        
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Product name is required")]
        public string? Name { get; set; }
        
        public string? Description { get; set; }
        
        public ProductQuality Quality { get; set; }
        
        public string? Notes { get; set; }
        
        public int StockOnHand { get; set; }
    }
}
