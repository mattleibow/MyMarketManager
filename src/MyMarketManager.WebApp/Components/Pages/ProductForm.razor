@page "/products/add"
@page "/products/edit/{productId:guid}"
@rendermode InteractiveServer
@using MyMarketManager.Api.Models
@using MyMarketManager.Data.Enums
@using MyMarketManager.ApiClient
@inject ProductsClient ProductsClient
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>@(ProductId.HasValue ? "Edit Product" : "Add Product")</PageTitle>

<div class="row">
    <div class="col-md-8">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/products">Products</a></li>
                <li class="breadcrumb-item active">@(ProductId.HasValue ? "Edit" : "Add")</li>
            </ol>
        </nav>

        <h1>@(ProductId.HasValue ? "Edit Product" : "Add Product")</h1>

        <EditForm Model="@productRequest" OnValidSubmit="@SaveProduct" FormName="ProductForm">
            <DataAnnotationsValidator />
            <ValidationSummary class="alert alert-danger" />

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="sku" class="form-label">SKU</label>
                        <InputText id="sku" class="form-control" @bind-Value="productRequest.SKU" placeholder="Optional product SKU" />
                        <ValidationMessage For="@(() => productRequest.SKU)" />
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="quality" class="form-label">Quality Rating</label>
                        <InputSelect id="quality" class="form-select" @bind-Value="productRequest.Quality">
                            @foreach (var quality in Enum.GetValues<ProductQuality>())
                            {
                                <option value="@quality">@quality</option>
                            }
                        </InputSelect>
                        <ValidationMessage For="@(() => productRequest.Quality)" />
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="name" class="form-label">Product Name <span class="text-danger">*</span></label>
                <InputText id="name" class="form-control" @bind-Value="productRequest.Name" placeholder="Enter product name" />
                <ValidationMessage For="@(() => productRequest.Name)" />
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <InputTextArea id="description" class="form-control" rows="3" @bind-Value="productRequest.Description" placeholder="Product description (optional)" />
                <ValidationMessage For="@(() => productRequest.Description)" />
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="stock" class="form-label">Stock on Hand</label>
                        <InputNumber id="stock" class="form-control" @bind-Value="productRequest.StockOnHand" min="0" />
                        <ValidationMessage For="@(() => productRequest.StockOnHand)" />
                        <div class="form-text">Current inventory level</div>
                    </div>
                </div>
            </div>

            <div class="mb-3">
                <label for="notes" class="form-label">Notes</label>
                <InputTextArea id="notes" class="form-control" rows="2" @bind-Value="productRequest.Notes" placeholder="Additional notes (optional)" />
                <ValidationMessage For="@(() => productRequest.Notes)" />
            </div>

            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" disabled="@saving">
                    @if (saving)
                    {
                        <span class="spinner-border spinner-border-sm" role="status"></span>
                        <span>Saving...</span>
                    }
                    else
                    {
                        <i class="bi bi-check-circle"></i>
                        <span>@(ProductId.HasValue ? "Update Product" : "Create Product")</span>
                    }
                </button>
                <button type="button" class="btn btn-secondary" @onclick="Cancel">
                    Cancel
                </button>
            </div>
        </EditForm>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Quality Guide</h5>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <span class="badge bg-success">Excellent</span>
                        <div class="text-muted">Superior condition, no defects</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-primary">Good</span>
                        <div class="text-muted">Minor imperfections, fully functional</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-warning">Fair</span>
                        <div class="text-muted">Noticeable flaws but acceptable</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-danger">Poor</span>
                        <div class="text-muted">Significant defects, limited usability</div>
                    </div>
                    <div class="mb-2">
                        <span class="badge bg-dark">Terrible</span>
                        <div class="text-muted">Severe damage, may not be sellable</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public Guid? ProductId { get; set; }

    private UpdateProductRequest productRequest = new();
    private bool saving = false;

    protected override async Task OnInitializedAsync()
    {
        if (ProductId.HasValue)
        {
            var existingProduct = await ProductsClient.GetProductAsync(ProductId.Value);
            
            if (existingProduct != null)
            {
                productRequest = new UpdateProductRequest
                {
                    SKU = existingProduct.SKU,
                    Name = existingProduct.Name,
                    Description = existingProduct.Description,
                    Quality = existingProduct.Quality,
                    Notes = existingProduct.Notes,
                    StockOnHand = existingProduct.StockOnHand
                };
            }
            else
            {
                // Product not found, redirect to products list
                Navigation.NavigateTo("/products");
            }
        }
        else
        {
            // Initialize default values for new product
            productRequest = new UpdateProductRequest
            {
                Name = string.Empty,
                Quality = ProductQuality.Good,
                StockOnHand = 0
            };
        }
    }

    private async Task SaveProduct()
    {
        saving = true;
        try
        {
            if (ProductId.HasValue)
            {
                // Update existing product
                await ProductsClient.UpdateProductAsync(ProductId.Value, productRequest);
            }
            else
            {
                // Add new product (convert to CreateProductRequest)
                var createRequest = new CreateProductRequest
                {
                    SKU = productRequest.SKU,
                    Name = productRequest.Name,
                    Description = productRequest.Description,
                    Quality = productRequest.Quality,
                    Notes = productRequest.Notes,
                    StockOnHand = productRequest.StockOnHand
                };
                await ProductsClient.CreateProductAsync(createRequest);
            }

            Navigation.NavigateTo("/products");
        }
        catch (Exception ex)
        {
            // Handle error - in production, use proper logging
            await JSRuntime.InvokeVoidAsync("alert", $"Error saving product: {ex.Message}");
        }
        finally
        {
            saving = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/products");
    }
}